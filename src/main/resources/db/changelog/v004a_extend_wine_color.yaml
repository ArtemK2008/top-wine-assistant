databaseChangeLog:
  - changeSet:
      id: v004a-extend-wine-color
      author: you
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        dbms:
          type: postgresql
      changes:
        - dropNotNullConstraint:
            tableName: wine_item
            columnName: wine_color
            columnDataType: varchar(32)

        - sql:
            stripComments: true
            splitStatements: false
            sql: |
              DO $$
              BEGIN
                IF EXISTS (
                  SELECT 1
                  FROM   pg_constraint c
                  JOIN   pg_class t ON t.oid = c.conrelid
                  WHERE  t.relname = 'wine_item'
                  AND    c.conname = 'chk_wine_item_color'
                ) THEN
                  ALTER TABLE wine_item DROP CONSTRAINT chk_wine_item_color;
                END IF;
                ALTER TABLE wine_item
                  ADD CONSTRAINT chk_wine_item_color
                  CHECK (wine_color IN ('red','white','rose','orange','sparkling'));
              END$$;
