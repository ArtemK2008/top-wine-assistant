databaseChangeLog:
  - changeSet:
      id: v001-create-wine-item
      author: you

      preConditions:
        onFail: MARK_RAN
        onError: HALT
        and:
          - dbms:
              type: postgresql
          - not:
              tableExists:
                tableName: wine_item

      changes:
        - createTable:
            tableName: wine_item
            remarks: "Карточка вина (read-only справочник для ассистента)"
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_wine_item
                    nullable: false

              - column:
                  name: wine_name
                  type: TEXT
                  remarks: "Например: Chianti Classico Riserva"
                  constraints:
                    nullable: false

              - column: { name: producer_name,   type: TEXT }
              - column: { name: country_name,    type: TEXT }
              - column: { name: region_name,     type: TEXT }
              - column: { name: grape_varieties, type: TEXT, remarks: "Например: Sangiovese" }

              - column:
                  name: wine_color
                  type: TEXT
                  remarks: "red | white | rose | orange"

              - column:
                  name: vintage_year
                  type: INT

              - column:
                  name: bottle_size_ml
                  type: INT
                  defaultValueNumeric: 750
                  constraints:
                    nullable: false

              - column:
                  name: alcohol_by_volume
                  type: NUMERIC(4,2)
                  remarks: "ABV в процентах, например 13.5"

              - column: { name: description_notes, type: TEXT }
              - column: { name: tags_json,         type: jsonb }

              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: now()
                  constraints:
                    nullable: false

              - column:
                  name: updated_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: now()
                  constraints:
                    nullable: false

        - sql:
            sql: >
              ALTER TABLE wine_item
              ADD CONSTRAINT chk_wine_item_color
              CHECK (wine_color IN ('red','white','rose','orange') OR wine_color IS NULL);

        - sql:
            sql: >
              ALTER TABLE wine_item
              ADD CONSTRAINT chk_wine_item_vintage_year
              CHECK ((vintage_year BETWEEN 1900 AND 2100) OR vintage_year IS NULL);

      rollback:
        - sql:
            sql: |
              ALTER TABLE IF EXISTS wine_item DROP CONSTRAINT IF EXISTS chk_wine_item_vintage_year;
              ALTER TABLE IF EXISTS wine_item DROP CONSTRAINT IF EXISTS chk_wine_item_color;
        - dropTable:
            tableName: wine_item
            cascadeConstraints: true